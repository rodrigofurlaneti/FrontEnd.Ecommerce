<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Título da Página</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Navbar</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="cadastro.html">Cadastro</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="contato.html">Contato</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="produto.html">Produto</a>
                        </li>
                    </ul>
                    <form class="d-flex" role="login">
                        <button id="btnLogin" name="btnLogin" class="btn btn-outline-success" type="button"
                                data-bs-toggle="modal"
                                data-bs-target="#modalLogin">
                            olá, faça seu login
                        </button>
                        <span id="userGreeting" class="ms-2" style="display: none;">
                            Olá,
                            <span id="userName"></span>
                            <img id="icoVerifiedOk" name="icoVerifiedOk" src="assets/icon/verified_ok.png" style="height:22px;">
                            <button type="button" class="btn btn-outline-default position-relative">
                                <img id="icoCartMarket" name="icoCartMarket" class="position-relative" 
                                     src="assets/icon/cart_market.png" style="height:36px;">
                                <span id="countProductOrder" name="countProductOrder" 
                                     class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                  0
                                  <span class="visually-hidden">unread messages</span>
                                </span>
                              </button>
                        </span>
                    </form>
                </div>
            </div>
        </nav>
    </header>

    <div class="text-center my-3">
        <button id="btnMobile" name="btnMobile" class="btn btn-default btn-sm">
            <img id="icoMobile" name="icoMobile" src="assets/icon/list_mobile.png" style="height:18px;">
        </button>
        <button id="btnDesktop" name="btnDesktop" class="btn btn-default btn-sm">
            <img id="icoDesktop" name="icoDesktop" src="assets/icon/grid_desktop.png" style="height:18px;">
        </button>
    </div>

    <div id="layout-mobile" name="layout-mobile" class="table-responsive" style="display: none;">
        <table class="table">
            <tbody id="product-table-body-mobile">
            </tbody>
        </table>
    </div>

    <div id="layout-desktop" name="layout-desktop" class="container">
        <div class="row justify-content-center" id="product-table-body-desktop">
        </div>
    </div>

    <footer class="text-center mt-5">
        <p>© 2024 Meu Site. Todos os direitos reservados.</p>
    </footer>

    <!-- Modal Login -->
    <div class="modal fade" id="modalLogin" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Acesse sua conta</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Pra ver seus pedidos e ter uma experiência personalizada, acesse sua conta :)
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAutenticacao">Entrar</button>
                    <a href="cadastro.html" class="btn btn-secondary btn-sm">Cadastrar</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Autenticação -->
    <div class="modal fade" id="modalAutenticacao" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Acesse sua conta</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container mt-12">
                        <div class="row justify-content-center">
                            <div class="col-md-12">
                                <form id="authenticationForm" name="authenticationForm">
                                    <div class="row mb-12">
                                        <div class="col-md-12">
                                            <label for="username" class="form-label text-center">Usuário</label>
                                            <input type="text" class="form-control form-control-sm" id="username" name="username" placeholder="Usuário" required>
                                        </div>
                                    </div>
                                    <div class="row mb-12">
                                        <div class="col-md-12">
                                            <label for="password" class="form-label text-center">Senha</label>
                                            <input type="password" class="form-control form-control-sm" id="password" name="password" placeholder="Senha" required>
                                        </div>
                                    </div>
                                    <div class="row mb-12">
                                        <div class="col-md-12">
                                            <div class="d-flex justify-content-center" style="padding-top:2em;">
                                                <button type="submit" id="btnAutenticarAcesso" name="btnAutenticarAcesso" class="btn btn-primary btn-sm">
                                                    Enviar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            // Função para alternar a visibilidade dos layouts
            function toggleLayout(layoutToShow) {
                if (layoutToShow === 'mobile') {
                    $('#layout-mobile').show();
                    $('#layout-desktop').hide();
                } else {
                    $('#layout-mobile').hide();
                    $('#layout-desktop').show();
                }
            }

            // Mostrar layout desktop por padrão
            toggleLayout('desktop');

            // Eventos de clique para os botões
            $('#btnMobile').click(function () {
                toggleLayout('mobile');
            });

            $('#btnDesktop').click(function () {
                toggleLayout('desktop');
            });

            // Requisição AJAX para buscar os produtos
            function fetchProducts() {
                $.ajax({
                    url: 'https://localhost:7274/api/Product',
                    method: 'GET',
                    success: function (data) {
                        var tableBodyMobile = $('#product-table-body-mobile');
                        var tableBodyDesktop = $('#product-table-body-desktop');
                        data.forEach(function (product) {
                            var rowMobile = $('<tr></tr>');
                            var colDesktop = $('<div class="col-md-4 mb-3"></div>'); // Alterado para col-md-4

                            var productHtml = `
                                <div class="card" style="width: 18rem;">
                                    <div class="d-flex justify-content-center">
                                        <img id="productPicture" name="productPicture" class="imgDefault" src="assets/img/${product.picture}" class="card-img-top" alt="...">
                                    </div>
                                    <div class="card-body">
                                        <input type="hidden" id="idProduct" name="idProduct" value="${product.id}"/>
                                        <input type="hidden" id="amount" name="amount" value="1"/>
                                        <h6 class="card-title text-center">${product.name}</h6>
                                        <p id="productDetails" name="productDetails" class="card-text text-justify text-details">${product.details}</p>
                                        <p class="text-center text-details">Valor de  <s>R$${product.valueOf}</s></p>
                                        <p class="text-center">por <span class="badge text-bg-success">R$${product.valueFor}</span></p>
                                        <p class="text-center"><span class="badge text-bg-danger">Desconto de ${product.discount}%</span></p>
                                        <p class="text-center text-amount">Quantidade disponível: ${product.amount}</p>
                                        <div class="d-flex justify-content-center">
                                            <a href="#" class="btn btn-default btn-sm adicionarCarrinho" name="adicionarCarrinho">
                                                <img id="icoCartPlus" name="icoCartPlus" src="assets/icon/cart_plus.png" style="height:18px;">
                                                Adicionar no carrinho
                                            </a>
                                        </div>
                                    </div>
                                </div>`;

                            rowMobile.html(`<td class="d-flex align-items-center justify-content-center">${productHtml}</td>`);
                            colDesktop.html(productHtml);

                            tableBodyMobile.append(rowMobile);
                            tableBodyDesktop.append(colDesktop);
                        });
                    },
                    error: function (error) {
                        console.error('Erro ao buscar os dados:', error);
                    }
                });
            }

            // Chamar a função para buscar produtos quando o documento estiver pronto
            fetchProducts();

            // Função para buscar o pedido por ID e atualizar o countProductOrder
            function fetchOrderById(orderId) {
                fetch(`https://localhost:7274/api/Order/${orderId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Detalhes do pedido:', data);
                        // Atualiza o elemento com o id countProductOrder
                        $('#countProductOrder').text(data);
                    })
                    .catch(error => {
                        console.error('Erro ao buscar o pedido:', error);
                    });
            }

            // Evento de clique para adicionar ao carrinho
            $(document).on('click', '.adicionarCarrinho', function (event) {
                event.preventDefault(); // Impede o comportamento padrão do link

                var idProduct = $(this).closest('.card-body').find('input[name="idProduct"]').val();
                var userId = sessionStorage.getItem('id');
                var amount = $(this).closest('.card-body').find('input[name="amount"]').val();
                var orderId = sessionStorage.getItem('orderId') ? sessionStorage.getItem('orderId') : 0;

                if (!userId) {
                    alert('Você precisa estar logado para adicionar produtos ao carrinho.');
                    return;
                }

                var orderData = {
                    userId: userId,
                    productId: idProduct,
                    amount: amount,
                    orderId: orderId 
                };

                fetch('https://localhost:7274/api/Order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        console.log('Produto adicionado ao carrinho:', data);

                        // Se o idOrder for maior que zero, busca o pedido e atualiza o countProductOrder
                        if (data.id > 0) {
                            // Salva o idOrder no sessionStorage
                            sessionStorage.setItem('orderId', data.id);
                            alert('Produto adicionado ao carrinho com sucesso!');
                            fetchOrderById(data.id);
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao adicionar produto ao carrinho:', error);
                        alert('Erro ao adicionar produto ao carrinho.');
                    });
            });

            // Adiciona o evento de submit ao formulário de autenticação
            $('#authenticationForm').on('submit', function (event) {
                event.preventDefault(); // Impede o envio padrão do formulário

                const formData = {
                    username: $('#username').val(),
                    password: $('#password').val()
                };

                fetch('https://localhost:7274/api/Authentication', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                    .then(response => {
                        if (response.status === 401) {
                            throw new Error('Unauthorized');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Sucesso:', data);
                        if (data.status) {
                            // Salva o username e status no sessionStorage
                            sessionStorage.setItem('id', data.id);
                            sessionStorage.setItem('name', data.name);
                            sessionStorage.setItem('username', data.username);
                            sessionStorage.setItem('status', data.status);

                            // Oculta o botão de login
                            $('#btnLogin').hide();

                            // Exibe a saudação
                            $('#userName').text(data.name);
                            $('#userGreeting').show();

                            alert('Autenticação realizada com sucesso!');
                            // Fechar o modal de autenticação
                            $('#modalAutenticacao').modal('hide');
                        } else {
                            alert('Erro ao autenticar o usuário.');
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        if (error.message === 'Unauthorized') {
                            alert('Usuário ou senha incorretos.');
                        } else {
                            alert('Erro ao autenticar o usuário.');
                        }
                    });
            });
        });
    </script>
</body>
</html>